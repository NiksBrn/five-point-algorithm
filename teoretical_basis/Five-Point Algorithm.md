# Алгоритм 5 точек
## 1 Этап.
На первом этапе распишем уравнение $x^TEx'=0$ в виде $Ye=0$, возьмем 5 точек, получим $Ae=0$, где матрица $A$ это матрица размера $5 * 9$ (5 столбцов, 9 строк).
Очевидно получим решение в виде $$E=xE_1+yE_2+zE_3+wE_4$$. Матрица эссенций определена с точностью до масштаба, поэтому можно положить $w=1$.
## 2 Этап.
Для фундаментальной матрицы и матрицы эссенций есть свойство $$det(E)=0$$.
Но только для матрицы эссенций есть свойство, устанавливающие, что два сингулярный числа равны, а третье - 0: $$2EE^TE-tr(EE^T)E=0$$
Подставим в эти уравнения решение однородной системы, получим матрицу 10 на 20 вида: $$\begin{array}
{} & x^3 & x^2y & x^2z & xy^2 & xz^2 & xyz & y^3 & y^2z & yz^2 & z^3 & x^2 & xy & xz & y^2 & yz & z^2 & x & y & z & 1 \\ <a> &&&&&&&&&&&&&&&&&&&& \\ <b> \\ <c> \\ <d> \\ <e> \\ <f> \\ <g> \\ <h> \\ <i> \\ <j> \end{array}$$
Далее можно действовать несколькими способами, смысл один - найти переменную z, потом найти x, y через svd разложение, то есть строится система $$C(Z)vec(args)=0$$ где $args$ - это вектор мономов, зависит от выражения.
### Возможные варианты
В [статье](https://users.cecs.anu.edu.au/~hongdong/new5pt_cameraREady_ver_1.pdf) предлагается решение системы через метод скрытой переменной. В системе из $M$ полиномиальных уравнений $N$ переменных, назовем $p_i(x_1, x_2, \ldots, x_N)=0\quad i=1, \ldots, M$ Рассмотрим одну из переменных как параметр (пусть это будет $x_1$), тогда с помощью простой группировки слагаемых можно переписать систему уравнений как матричное уравнение $C(x_1)X=0$, где коэффициенты матрицы $C(x_1)$ зависят от скрытой переменной $x_1$, а $X$ - это векторное пространство, состоящее из однородных мономов всех $N-1$ переменных $(x_2, x_3, \ldots, x_N)$. Если число уравнений совпадает с числом мономов, тогда система будет иметь не тривиальное решение тогда и только тогда, когда $det(C(x_1))=0$

#### Алгоритм
1. Строим систему из 10 уравнений и 20 мономов
2. Группируем слагаемые относительно $z$, тогда получаем $X=[x^3, y^3, x^2y, xy^2, x^2, y^2, xy, x, y, 1]^T$
3. Уравнений 10, мономов 10, необходимо решить $det(C(z))=0$
4. Находим корни полинома по $z$
5. Подставляем корни в $C(z)$, находим значения остальных мономов.
#### Проблемы
Основная проблема возникает при вычислении $det(C(z))$, определитель необходимо посчитать символьно, при этом получится $10!$ слагаемых. Данный способ является слишком затратным и неэффективным
### Оригинальная статья Нистера
В данной [статье](http://www.cad.zju.edu.cn/home/gfzhang/training/SFM/2004-PAMI-David%20Nister-An%20Efficient%20Solution%20to%20the%20Five-Point%20Relative%20Pose%20Problem.pdf) предлагается следующий вариант решения:
1. Составление матрицы коэффициентов $10\times20$, описано выше
2. Вынесение z как параметра в коэффициенты, приводим матрицу к ступенчатому виду. Получим: $$\begin{array}
{} & x^3 & y^3 & x^2y & xy^2 & x^2z & x^2 & y^2z & y^2 & xyz & xy & x & y & 1 \\ <a> &  1 & . & . & . &.&.&.&.&.&.& [2]&[2]&[3]
  \\ <b> & & 1&.&.&.&.&.&.&.&.&[2]&[2]&[3] \\ <c> & & &1&.&.&.&.&.&.&.&[2]&[2]&[3] \\ <d> & & & & 1&.&.&.&.&.&.&[2]&[2]&[3] \\ <e> & & & & & 1&&&&&&[2]&[2]&[3] \\ <f> &&&&&&1&&&&&[2]&[2]&[3] \\ <g> &&&&&&&1&&&&[2]&[2]&[3]\\ <h> &&&&&&&&1&&&[2]&[2]&[3] \\ <i> &&&&&&&&&1&&[2]&[2]&[3] \\ <j> &&&&&&&&&&1&[2]&[2]&[3] \end{array}$$ где . - это скаляр, $[n]$ - полином степени n относительно z
1. Определение дополнительных уравнений $$\begin{matrix} <k> = <e>-z<f> \\ <l> = <g> - z<h> \\ <m> = <i> - z<j> \end{matrix}$$
2. Таким образом получаем матрицу $B(z)$: $$\begin{array}
{} & x & y & 1 \\ <k> & [3] & [3] & [4] \\ <l> & [3] & [3] & [4] \\ <m> & [3]&[3]&[4]\end{array}$$
1. Считаем $det(B(z))=0$, находим реальные корни, подставляем обратно, находим $x$, $y$.
#### Проблемы
Данная реализация требует символьного приведения к ступенчатому виду, что является дорогой операцией.
### Реализация
В качестве основы возьмем реализацию OpenCV.
Аналогично построим систему из 10 уравнений и переписываем в матрицу $10\times20$
Далее проведем следующие действия над матрицей. Сейчас имеем: $$A*X=0$$, $A$ - матрица коэффициентов, $X$ - вектор из 20 мономов. Перепишем это в виде:$$A_{left}X_{left}+A_{right}X_{right}=0$$
Разложили матрицу $A$ на две части, где левая часть - старшие мономы 3 степени, правая часть - все остальные. Теперь выражаем $X_{left}=-A_{left}^{-1}A_{right}X_{right}$. Назовем $a=-A_{left}^{-1}A_{right}$
Теперь составим матрицу $B(z)$ для решения $B(z)*[x, y, 1]^T=0$.
Для этого берем пары строк из матрицы a: (4, 5), (6, 7), (8, 9). Далее в каждой паре вычитаем вторую строку из первой, домноженную на z. $$row = arow[i] - z*arow[j]$$
теперь можно найти $det(B(z))$. Это полином 10 степени по z, максимум 10 корней, выбираем только реальные. Для каждого корня подставляем значение в матрицу $B$ и с помощью SVD находим вектор $[x, y, 1]^T$ как последний правый сингулярный вектор. Получаемый кортех (x, y, z) образует одну возможную матрицу $E$.